name: ğŸ”¨ Build Test

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

jobs:
    test:
        name: ğŸ§ª Test
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¦ Checkout
              uses: actions/checkout@v4

            - name: ğŸ”§ Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.26.0"

            - name: ğŸ“¥ Cache Go modules
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/go-build
                      ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: ğŸ“¦ Download dependencies
              run: go mod download

            - name: ğŸ” Run go vet
              run: go vet ./...

            - name: ğŸ§ª Run tests with race detector
              run: go test -v -race ./...

            - name: ğŸ“Š Run tests with coverage
              run: |
                  go test -v -coverprofile=coverage.out ./...
                  go tool cover -html=coverage.out -o coverage.html

            - name: ğŸ“Š Upload coverage reports
              uses: codecov/codecov-action@v4
              with:
                  file: ./coverage.out
                  flags: unittests
                  name: codecov-umbrella

            - name: ğŸ”¨ Build binary
              run: |
                  go build -o yggdrasil-api-server main.go
                  ./yggdrasil-api-server -version || echo "Version command not implemented yet"

            - name: ğŸ§ª Integration test
              run: |
                  # åˆ›å»ºæµ‹è¯•é…ç½®
                  mkdir -p conf keys
                  cp conf/example.yml conf/test.yml

                  # ç”Ÿæˆæµ‹è¯•å¯†é’¥
                  openssl genrsa -out keys/private.pem 2048
                  openssl rsa -in keys/private.pem -pubout -out keys/public.pem

                  # å¯åŠ¨æœåŠ¡å™¨è¿›è¡Œé›†æˆæµ‹è¯•
                  timeout 30s ./yggdrasil-api-server -config conf/test.yml &
                  sleep 5

                  # æµ‹è¯•APIç«¯ç‚¹
                  curl -f http://localhost:8080/ || echo "Server not ready for testing"

            - name: ğŸ“¤ Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-artifacts
                  path: |
                      yggdrasil-api-server
                      coverage.html
                  retention-days: 7
